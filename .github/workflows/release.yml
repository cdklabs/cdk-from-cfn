# .github/workflows/release.yml

name: release
on:
  push:
    branches:
      - release

jobs:
  release_to_crates:
    name: Release to crates.io
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@main
      - name: Set git identity
        run: |-
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
      - name: Install cargo-release
        uses: taiki-e/install-action@main
        with:
          tool: cargo-binstall
      - uses: cargo-bins/release-pr@main
        with:
          github-token: ${{ secrets.PROJEN_GITHUB_TOKEN }}
          version: minor
          pr-title: |
            release: <%= crate.name %> v<%= version.actual %>
          pr-label: auto-approve
          pr-template: |
            Release cdk-from-cfn

            [Workflow Run]: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          pr-release-notes: true
          branch-prefix: github-actions/release
          check-semver: true
          git-user-name: github-actions
          git-user-email: github-actions@github.com
    env:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_TOKEN }}

  release_to_npm:
    name: Release to npm
    needs: release_to_crates
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@main
      - name: Setup Node.js
        uses: actions/setup-node@main
        with:
          node-version: latest
      - uses: jetli/wasm-pack-action@v0.4.0
        name: Install wasm-pack
        with:
          version: latest
      - name: Prepare Release
        run: |-
          wasm-pack build --all-features --target=nodejs --out-name=index
      - name: Release
        run: |-
          npm set "//registry.npmjs.org/:_authToken" ${{ secrets.NPM_TOKEN }}
          wasm-pack publish --tag latest
