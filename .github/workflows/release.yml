# .github/workflows/release.yml

name: release
on:
  workflow_dispatch: {}
  schedule:
    - cron: 0 0 * * *

jobs:
  release_to_crates:
    name: Release to crates.io
    runs-on: ubuntu-latest
    steps:
      - name: Install dependencies
        run: |-
          curl https://sh.rustup.rs -sSf | sh
          cargo install cargo-release
      - name: Release crate
        run: cargo release --all-features --verbose minor
    env:
      CARGO_REGISTRY_TOKEN: ${{ secrets.CRATES_TOKEN }}

  release_to_npm:
    name: Release to npm
    needs: release_to_crates
    runs-on: ubuntu-latest
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@main
        with:
          node-version: latest
      - uses: jetli/wasm-pack-action@v0.4.0
        name: Install wasm-pack
        with:
          version: latest
      - name: Prepare Release
        run: |-
          wasm-pack build --all-features --target=nodejs --out-name=index
      - name: Release
        run: |-
          npm set "//registry.npmjs.org/:_authToken" ${{ secrets.NPM_TOKEN }}
          wasm-pack publish --tag latest
