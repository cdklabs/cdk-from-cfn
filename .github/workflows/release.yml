# .github/workflows/release.yml
name: Release from release branch

on:
  workflow_dispatch: {}
  push:
    branches:
      - release

env:
  RELEASE_BRANCH: release
  MERGEBACK_BRANCH: github-actions/mergeback

jobs:
  create_mergeback:
    name: Create the merge-back PR
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_BRANCH }}
          token: ${{ secrets.PROJEN_GITHUB_TOKEN }}

      - name: Open merge-back pull request
        run: |
          git fetch origin main
          git push -f origin HEAD:${{ env.MERGEBACK_BRANCH }}
          git checkout ${{ env.MERGEBACK_BRANCH }}

          env GITHUB_TOKEN=${{ secrets.PROJEN_GITHUB_TOKEN }} gh pr create \
            --title "chore: merge-back" \
            --fill \
            --base main \
            --label auto-approve \
            --label pr/no-squash

  release_to_npm:
    name: Release to NPM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ env.RELEASE_BRANCH }}
          token: ${{ secrets.PROJEN_GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@main
        with:
          node-version: lts/*

      - name: ðŸ¦€ Install Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1

      - name: âš¡ Cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
            ${{ runner.os }}-cargo

      - name: Install wasm-pack
        uses: baptiste0928/cargo-install@v3
        with:
          crate: wasm-pack

      - name: Prepare Release
        run: |-
          wasm-pack build --all-features --target=nodejs --out-name=index

      - name: Release
        run: |-
          npm set "//registry.npmjs.org/:_authToken" ${{ secrets.NPM_TOKEN }}
          wasm-pack publish --tag latest
