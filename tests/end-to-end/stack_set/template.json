{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Deploy required components for StackSet custom resources in this region.  Lambda ARN is exported as StackSetCustomResource",
  "Parameters": {
      "ModuleName": {
          "Type": "String",
          "Default": "lambda_function"
      },
      "RoleName": {
          "Type": "String",
          "Default": ""
      },
      "RolePath": {
          "Type": "String",
          "Default": ""
      }
  },
  "Conditions": {
      "UseRoleName": {
          "Fn::Not": [
              {
                  "Fn::Equals": [
                      {
                          "Ref": "RoleName"
                      },
                      ""
                  ]
              }
          ]
      },
      "UseRolePath": {
          "Fn::Not": [
              {
                  "Fn::Equals": [
                      {
                          "Ref": "RolePath"
                      },
                      ""
                  ]
              }
          ]
      }
  },
  "Resources": {
      "StackSetResourceRole": {
          "Type": "AWS::IAM::Role",
          "Properties": {
              "RoleName": {
                  "Fn::If": [
                      "UseRoleName",
                      {
                          "Ref": "RoleName"
                      },
                      {
                          "Ref": "AWS::NoValue"
                      }
                  ]
              },
              "Path": {
                  "Fn::If": [
                      "UseRolePath",
                      {
                          "Ref": "RolePath"
                      },
                      "/"
                  ]
              },
              "AssumeRolePolicyDocument": {
                  "Version": "2012-10-17",
                  "Statement": [
                      {
                          "Effect": "Allow",
                          "Principal": {
                              "Service": "lambda.amazonaws.com"
                          },
                          "Action": "sts:AssumeRole"
                      }
                  ]
              },
              "Policies": [
                  {
                      "PolicyName": "IAMPassRolePermissions",
                      "PolicyDocument": {
                          "Version": "2012-10-17",
                          "Statement": [
                              {
                                  "Effect": "Allow",
                                  "Action": "iam:PassRole",
                                  "Resource": "*"
                              }
                          ]
                      }
                  },
                  {
                      "PolicyName": "CloudFormationPermissions",
                      "PolicyDocument": {
                          "Version": "2012-10-17",
                          "Statement": [
                              {
                                  "Effect": "Allow",
                                  "Action": "cloudformation:*",
                                  "Resource": "*"
                              }
                          ]
                      }
                  },
                  {
                      "PolicyName": "LambdaPermissions",
                      "PolicyDocument": {
                          "Version": "2012-10-17",
                          "Statement": [
                              {
                                  "Effect": "Allow",
                                  "Action": "logs:CreateLogGroup",
                                  "Resource": [
                                      {
                                          "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:*"
                                      }
                                  ]
                              },
                              {
                                  "Effect": "Allow",
                                  "Action": [
                                      "logs:CreateLogStream",
                                      "logs:PutLogEvents"
                                  ],
                                  "Resource": [
                                      {
                                          "Fn::Sub": "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*"
                                      }
                                  ]
                              }
                          ]
                      }
                  },
                  {
                      "PolicyName": "S3Permissions",
                      "PolicyDocument": {
                          "Version": "2012-10-17",
                          "Statement": [
                              {
                                  "Effect": "Allow",
                                  "Action": [
                                      "s3:Get*",
                                      "s3:List*"
                                  ],
                                  "Resource": "*"
                              }
                          ]
                      }
                  }
              ]
          }
      }
  }
}